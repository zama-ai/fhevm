services:
  # =============================================================================
  # COPROCESSOR BUILD CACHING STRATEGY
  # =============================================================================
  # All coprocessor services share a single Dockerfile.workspace with multi-stage
  # targets. When docker-compose builds them in parallel, each service is a separate
  # BuildKit invocation.
  #
  # To avoid cache write conflicts (multiple processes writing to same directory),
  # we use a SINGLE EXPORTER pattern:
  #   - ALL services: cache_from (read from shared cache) ✓
  #   - ONLY tfhe-worker: cache_to (write to shared cache) ✓
  #   - Other services: no cache_to (read-only)
  #
  # tfhe-worker is chosen as the exporter because it's typically the largest build
  # and shares all common layers with other services.
  # =============================================================================

  coprocessor-db-migration:
    container_name: coprocessor-db-migration
    image: ghcr.io/zama-ai/fhevm/coprocessor/db-migration:${COPROCESSOR_DB_MIGRATION_VERSION}
    build:
      context: ../../..
      dockerfile: coprocessor/fhevm-engine/Dockerfile.workspace
      target: db-migration
      args:
        CARGO_PROFILE: ${FHEVM_CARGO_PROFILE:-release}
      cache_from:
        - ${FHEVM_CACHE_FROM_COPROCESSOR:-type=gha}
    env_file:
      - ../env/staging/.env.coprocessor
    environment:
      - KEY_ID=${FHE_KEY_ID}
    command:
      - /initialize_db.sh
    volumes:
      - keys-cache:/fhevm-keys

  ####################### COPROCESSOR SERVICES #######################
  coprocessor-host-listener:
    container_name: coprocessor-host-listener
    image: ghcr.io/zama-ai/fhevm/coprocessor/host-listener:${COPROCESSOR_HOST_LISTENER_VERSION}
    build:
      context: ../../..
      dockerfile: coprocessor/fhevm-engine/Dockerfile.workspace
      target: host-listener
      args:
        CARGO_PROFILE: ${FHEVM_CARGO_PROFILE:-release}
      cache_from:
        - ${FHEVM_CACHE_FROM_COPROCESSOR:-type=gha}
    env_file:
      - ../env/staging/.env.coprocessor
    command:
      - host_listener
      - --database-url=${DATABASE_URL}
      - --coprocessor-api-key=${TENANT_API_KEY}
      - --acl-contract-address=${ACL_CONTRACT_ADDRESS}
      - --tfhe-contract-address=${FHEVM_EXECUTOR_CONTRACT_ADDRESS}
      - --url=${RPC_WS_URL}
      - --initial-block-time=1
    depends_on:
      coprocessor-db-migration:
        condition: service_completed_successfully

  coprocessor-host-listener-poller:
    container_name: coprocessor-host-listener-poller
    image: ghcr.io/zama-ai/fhevm/coprocessor/host-listener:${COPROCESSOR_HOST_LISTENER_VERSION}
    build:
      context: ../../..
      dockerfile: coprocessor/fhevm-engine/Dockerfile.workspace
      target: host-listener
      args:
        CARGO_PROFILE: ${FHEVM_CARGO_PROFILE:-release}
      cache_from:
        - ${FHEVM_CACHE_FROM_COPROCESSOR:-type=gha}
    env_file:
      - ../env/staging/.env.coprocessor
    command:
      - host_listener_poller
      - --database-url=${DATABASE_URL}
      - --coprocessor-api-key=${TENANT_API_KEY}
      - --acl-contract-address=${ACL_CONTRACT_ADDRESS}
      - --tfhe-contract-address=${FHEVM_EXECUTOR_CONTRACT_ADDRESS}
      - --url=${RPC_HTTP_URL}
    depends_on:
      coprocessor-db-migration:
        condition: service_completed_successfully

  coprocessor-gw-listener:
    container_name: coprocessor-gw-listener
    image: ghcr.io/zama-ai/fhevm/coprocessor/gw-listener:${COPROCESSOR_GW_LISTENER_VERSION}
    build:
      context: ../../..
      dockerfile: coprocessor/fhevm-engine/Dockerfile.workspace
      target: gw-listener
      args:
        CARGO_PROFILE: ${FHEVM_CARGO_PROFILE:-release}
      cache_from:
        - ${FHEVM_CACHE_FROM_COPROCESSOR:-type=gha}
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/liveness || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
    env_file:
      - ../env/staging/.env.coprocessor
    command:
      - gw_listener
      - --database-url=${DATABASE_URL}
      - --database-pool-size=16
      - --verify-proof-req-database-channel=event_zkpok_new_work
      - --gw-url=${GATEWAY_WS_URL}
      - --input-verification-address=${INPUT_VERIFICATION_ADDRESS}
      - --kms-generation-address=${KMS_GENERATION_ADDRESS}
      - --error-sleep-initial-secs=1
      - --error-sleep-max-secs=10
    depends_on:
      coprocessor-db-migration:
        condition: service_completed_successfully

  coprocessor-tfhe-worker:
    container_name: coprocessor-tfhe-worker
    image: ghcr.io/zama-ai/fhevm/coprocessor/tfhe-worker:${COPROCESSOR_TFHE_WORKER_VERSION}
    build:
      context: ../../..
      dockerfile: coprocessor/fhevm-engine/Dockerfile.workspace
      target: tfhe-worker
      args:
        CARGO_PROFILE: ${FHEVM_CARGO_PROFILE:-release}
      cache_from:
        - ${FHEVM_CACHE_FROM_COPROCESSOR:-type=gha}
      cache_to:
        - ${FHEVM_CACHE_TO_COPROCESSOR:-type=gha,mode=max}
    env_file:
      - ../env/staging/.env.coprocessor
    command:
      - tfhe_worker
      - --run-bg-worker
      - --database-url=${DATABASE_URL}
      - --pg-pool-max-connections=10
      - --worker-polling-interval-ms=1000
      - --work-items-batch-size=10
      - --tenant-key-cache-size=32
      - --coprocessor-fhe-threads=8
      - --tokio-threads=4
    depends_on:
      coprocessor-db-migration:
        condition: service_completed_successfully

  coprocessor-zkproof-worker:
    container_name: coprocessor-zkproof-worker
    image: ghcr.io/zama-ai/fhevm/coprocessor/zkproof-worker:${COPROCESSOR_ZKPROOF_WORKER_VERSION}
    build:
      context: ../../..
      dockerfile: coprocessor/fhevm-engine/Dockerfile.workspace
      target: zkproof-worker
      args:
        CARGO_PROFILE: ${FHEVM_CARGO_PROFILE:-release}
      cache_from:
        - ${FHEVM_CACHE_FROM_COPROCESSOR:-type=gha}
    env_file:
      - ../env/staging/.env.coprocessor
    command:
      - zkproof_worker
      - --database-url=${DATABASE_URL}
      - --pg-listen-channel=event_zkpok_new_work
      - --pg-notify-channel=event_zkpok_computed
      - --pg-polling-interval=5
      - --pg-pool-connections=5
      - --worker-thread-count=4
    depends_on:
      coprocessor-db-migration:
        condition: service_completed_successfully

  coprocessor-sns-worker:
    container_name: coprocessor-sns-worker
    image: ghcr.io/zama-ai/fhevm/coprocessor/sns-worker:${COPROCESSOR_SNS_WORKER_VERSION}
    build:
      context: ../../..
      dockerfile: coprocessor/fhevm-engine/Dockerfile.workspace
      target: sns-worker
      args:
        CARGO_PROFILE: ${FHEVM_CARGO_PROFILE:-release}
      cache_from:
        - ${FHEVM_CACHE_FROM_COPROCESSOR:-type=gha}
    env_file:
      - ../env/staging/.env.coprocessor
    command:
      - sns_worker
      - --database-url=${DATABASE_URL}
      - --tenant-api-key=${TENANT_API_KEY}
      - --pg-listen-channels
      - event_pbs_computations
      - event_ciphertext_computed
      - --pg-notify-channel
      - event_ciphertext128_computed
      - --work-items-batch-size=20
      - --pg-polling-interval=30
      - --pg-pool-connections=10
      - --bucket-name-ct64=ct64
      - --bucket-name-ct128=ct128
      - --s3-max-concurrent-uploads=100
      - --s3-max-retries-per-upload=100
      - --s3-max-backoff=10s
      - --s3-max-retries-timeout=120s
      - --s3-recheck-duration=2s
      - --s3-regular-recheck-duration=120s
      - --enable-compression
    depends_on:
      coprocessor-db-migration:
        condition: service_completed_successfully

  coprocessor-transaction-sender:
    container_name: coprocessor-transaction-sender
    image: ghcr.io/zama-ai/fhevm/coprocessor/tx-sender:${COPROCESSOR_TX_SENDER_VERSION}
    build:
      context: ../../..
      dockerfile: coprocessor/fhevm-engine/Dockerfile.workspace
      target: transaction-sender
      args:
        CARGO_PROFILE: ${FHEVM_CARGO_PROFILE:-release}
      cache_from:
        - ${FHEVM_CACHE_FROM_COPROCESSOR:-type=gha}
    env_file:
      - ../env/staging/.env.coprocessor
    command:
      - transaction_sender
      - --database-url=${DATABASE_URL}
      - --gateway-url=${GATEWAY_WS_URL}
      - --private-key=${TX_SENDER_PRIVATE_KEY}
      - --ciphertext-commits-address=${CIPHERTEXT_COMMITS_ADDRESS}
      - --input-verification-address=${INPUT_VERIFICATION_ADDRESS}
      - --multichain-acl-address=${MULTICHAIN_ACL_ADDRESS}
      - --database-pool-size=10
      - --database-polling-interval-secs=20
      - --verify-proof-resp-database-channel=event_zkpok_computed
      - --add-ciphertexts-database-channel=event_ciphertexts_uploaded
      - --verify-proof-resp-batch-limit=128
      - --verify-proof-resp-max-retries=15
      - --verify-proof-remove-after-max-retries
      - --signer-type=private-key
      - --host-chain-url=${RPC_WS_URL}
      - --delegation-block-delay=10
      - --delegation-clear-after-n-blocks=648000
      - --delegation-fallback-polling=30
      - --delegation-max-retry=100000
      - --retry-immediately-on-nonce-error=2
    depends_on:
      coprocessor-db-migration:
        condition: service_completed_successfully

volumes:
  keys-cache:
