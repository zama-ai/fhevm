# =============================================================================
# Coprocessor Configuration for Kind Deployment
# =============================================================================
# FHEVM coprocessor services including:
# - Database migration
# - Host listener (blockchain event processing)
# - Gateway listener (gateway event processing)
# - TFHE worker (FHE computation)
# - ZK proof worker (zero-knowledge proof generation)
# - SNS worker (notification service)
# - Transaction sender (blockchain transaction submission)
# Uses: charts/coprocessor
# =============================================================================

# -----------------------------------------------------------------------------
# Configuration Setup
# -----------------------------------------------------------------------------
config:
  enabled: true
  database:
    secret:
      name: coprocessor-db-url
      key: coprocessor-db-url
      value: "postgresql://postgres:postgres@postgresql:5432/coprocessor"

# -----------------------------------------------------------------------------
# Database Migration
# -----------------------------------------------------------------------------
dbMigration:
  enabled: true
  env:
    - name: CHAIN_ID
      value: "12345"
    - name: DATABASE_URL
      valueFrom:
        secretKeyRef:
          name: coprocessor-db-url
          key: coprocessor-db-url
    - name: TENANT_API_KEY
      valueFrom:
        secretKeyRef:
          name: coprocessor-api-key
          key: coprocessor-api-key
    # KMS public key URLs - these will be updated after KMS core initialization
    - name: PKS_URL
      value: "http://minio:9000/kms-public/PUB/PublicKey"
    - name: SKS_URL
      value: "http://minio:9000/kms-public/PUB/ServerKey"
    - name: PP_URL
      value: "http://minio:9000/kms-public/PUB/CRS"
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

# -----------------------------------------------------------------------------
# Host Listener
# -----------------------------------------------------------------------------
# Processes blockchain events from the host chain via WebSocket
hostListener:
  enabled: true
  replicas: 1
  env:
    - name: DATABASE_URL
      valueFrom:
        secretKeyRef:
          name: coprocessor-db-url
          key: coprocessor-db-url
    - name: TENANT_API_KEY
      valueFrom:
        secretKeyRef:
          name: coprocessor-api-key
          key: coprocessor-api-key
    - name: ETHEREUM_RPC_URL
      value: "ws://host-anvil-node:8545"
    - name: ACL_CONTRACT_ADDRESS
      value: "0x05fD9B5EFE0a996095f42Ed7e77c390810CF660c"
    - name: FHEVM_EXECUTOR_CONTRACT_ADDRESS
      value: "0xcCAe95fF1d11656358E782570dF0418F59fA40e1"
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

# -----------------------------------------------------------------------------
# Host Listener Poller
# -----------------------------------------------------------------------------
# Disabled - using WebSocket listener instead
hostListenerPoller:
  enabled: false

# -----------------------------------------------------------------------------
# Gateway Listener
# -----------------------------------------------------------------------------
# Processes events from the gateway chain
gwListener:
  enabled: true
  replicas: 1
  env:
    - name: KMS_GENERATION_ADDRESS
      value: "0x3b12Fc766Eb598b285998877e8E90F3e43a1F8d2"
  args:
    - --database-url=$(DATABASE_URL)
    - --database-pool-size=16
    - --verify-proof-req-database-channel=event_zkpok_new_work
    - --gw-url=ws://gateway-anvil-node:8546
    - --input-verification-address=$(INPUT_VERIFICATION_ADDRESS)
    - --kms-generation-address=$(KMS_GENERATION_ADDRESS)
    - --error-sleep-initial-secs=1
    - --error-sleep-max-secs=10
    - --health-check-port=8080
    - --metrics-addr=0.0.0.0:9100
    - --provider-max-retries=4294967295
    - --provider-retry-interval=4s
    - --log-level=INFO
    - --get-logs-poll-interval=500ms
    - --get-logs-block-batch-size=100
    - --service-name=gw-listener
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

# -----------------------------------------------------------------------------
# TFHE Worker
# -----------------------------------------------------------------------------
# Performs FHE (Fully Homomorphic Encryption) computations
tfheWorker:
  enabled: true
  replicas: 1
  env:
    - name: DATABASE_URL
      valueFrom:
        secretKeyRef:
          name: coprocessor-db-url
          key: coprocessor-db-url
    - name: TENANT_API_KEY
      valueFrom:
        secretKeyRef:
          name: coprocessor-api-key
          key: coprocessor-api-key
    - name: ACL_CONTRACT_ADDRESS
      value: "0x05fD9B5EFE0a996095f42Ed7e77c390810CF660c"
    - name: INPUT_VERIFIER_ADDRESS
      value: "0x857Ca72A957920Fa0FB138602995839866Bd4005"
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2000m
      memory: 4Gi

# -----------------------------------------------------------------------------
# ZK Proof Worker
# -----------------------------------------------------------------------------
# Generates zero-knowledge proofs for verification
zkProofWorker:
  enabled: true
  replicas: 1
  env:
    - name: DATABASE_URL
      valueFrom:
        secretKeyRef:
          name: coprocessor-db-url
          key: coprocessor-db-url
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 2Gi

# -----------------------------------------------------------------------------
# SNS Worker
# -----------------------------------------------------------------------------
# Handles ciphertext storage to S3/MinIO
snsWorker:
  enabled: true
  replicas: 1
  env:
    - name: DATABASE_URL
      valueFrom:
        secretKeyRef:
          name: coprocessor-db-url
          key: coprocessor-db-url
    - name: TENANT_API_KEY
      valueFrom:
        secretKeyRef:
          name: coprocessor-api-key
          key: coprocessor-api-key
    - name: AWS_ACCESS_KEY_ID
      value: "fhevm-access-key"
    - name: AWS_SECRET_ACCESS_KEY
      value: "fhevm-access-secret-key"
    - name: AWS_ENDPOINT_URL
      value: "http://minio:9000"
    - name: AWS_REGION
      value: "eu-west-1"
    - name: S3_BUCKET_NAME
      value: "ct128"
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

# -----------------------------------------------------------------------------
# Transaction Sender
# -----------------------------------------------------------------------------
# Submits transactions to the gateway chain
txSender:
  enabled: true
  replicas: 1
  env:
    - name: DATABASE_URL
      valueFrom:
        secretKeyRef:
          name: coprocessor-db-url
          key: coprocessor-db-url
    - name: TX_SENDER_PRIVATE_KEY
      value: "0x8f82b3f482c19a95ac29c82cf048c076ed0de2530c64a73f2d2d7d1e64b5cc6e"
    - name: ETHEREUM_RPC_URL
      value: "ws://host-anvil-node:8545"
    - name: INPUT_VERIFICATION_ADDRESS
      value: "0x1ceFA8E3F3271358218B52c33929Cf76078004c1"
    - name: CIPHERTEXT_COMMITS_ADDRESS
      value: "0xF0bFB159C7381F7CB332586004d8247252C5b816"
    - name: MULTICHAIN_ACL_ADDRESS
      value: "0xeAC2EfFA07844aB326D92d1De29E136a6793DFFA"
  args:
    - --input-verification-address=$(INPUT_VERIFICATION_ADDRESS)
    - --ciphertext-commits-address=$(CIPHERTEXT_COMMITS_ADDRESS)
    - --multichain-acl-address=$(MULTICHAIN_ACL_ADDRESS)
    - --gateway-url=ws://gateway-anvil-node:8546
    - --signer-type=private-key
    - --private-key=$(TX_SENDER_PRIVATE_KEY)
    - --database-url=$(DATABASE_URL)
    - --database-pool-size=10
    - --database-polling-interval-secs=1
    - --verify-proof-resp-database-channel=event_zkpok_computed
    - --add-ciphertexts-database-channel=event_ciphertexts_uploaded
    - --allow-handle-database-channel=event_allowed_handle
    - --verify-proof-resp-batch-limit=128
    - --verify-proof-resp-max-retries=6
    - --verify-proof-remove-after-max-retries
    - --add-ciphertexts-batch-limit=10
    - --allow-handle-batch-limit=10
    - --allow-handle-max-retries=2147483647
    - --add-ciphertexts-max-retries=2147483647
    - --error-sleep-initial-secs=1
    - --error-sleep-max-secs=4
    - --txn-receipt-timeout-secs=4
    - --review-after-unlimited-retries=30
    - --provider-max-retries=4294967295
    - --provider-retry-interval=4s
    - --health-check-port=8080
    - --metrics-addr=0.0.0.0:9100
    - --log-level=INFO
    - --service-name=txn-sender
    - --host-chain-url=$(ETHEREUM_RPC_URL)
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
