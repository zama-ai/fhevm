#!/bin/bash
set -e

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
LEGACY_CLI="${SCRIPT_DIR}/fhevm-cli.legacy"
BUN_CLI="${SCRIPT_DIR}/scripts/bun/cli.ts"
CLI_IMPL="${FHEVM_CLI_IMPL:-bun}"

should_fallback_to_legacy() {
  local command="${1:-}"
  shift || true

  # Not yet implemented in Bun parity path.
  if [[ "$command" == "smoke" ]]; then
    return 0
  fi

  # Multicoprocessor deploy flags currently live in legacy path.
  if [[ "$command" == "deploy" ]]; then
    for arg in "$@"; do
      if [[ "$arg" == "--coprocessors" || "$arg" == "--coprocessor-threshold" ]]; then
        return 0
      fi
    done
  fi

  return 1
}

if [[ "$CLI_IMPL" == "legacy" ]]; then
  exec "$LEGACY_CLI" "$@"
fi

if should_fallback_to_legacy "$@"; then
  echo "[WARN] requested flow is not implemented in Bun yet, falling back to legacy fhevm-cli implementation." >&2
  exec "$LEGACY_CLI" "$@"
fi

if ! command -v bun >/dev/null 2>&1; then
  echo "[WARN] bun runtime not found, falling back to legacy fhevm-cli implementation." >&2
  exec "$LEGACY_CLI" "$@"
fi

exec bun "$BUN_CLI" "$@"
