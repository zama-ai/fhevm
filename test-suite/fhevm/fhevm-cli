#!/bin/bash
set -e

BLUE='\033[0;34m'
LIGHT_BLUE='\033[1;34m'
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[0;33m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
BOLD='\033[1m'
RESET='\033[0m'

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PROJECT="fhevm"

# Default versions for the fhevm stack.

# KMS connector services.
export CONNECTOR_DB_MIGRATION_VERSION=${CONNECTOR_DB_MIGRATION_VERSION:-"v0.11.0-1"}
export CONNECTOR_GW_LISTENER_VERSION=${CONNECTOR_GW_LISTENER_VERSION:-"v0.11.0-1"}
export CONNECTOR_KMS_WORKER_VERSION=${CONNECTOR_KMS_WORKER_VERSION:-"v0.11.0-1"}
export CONNECTOR_TX_SENDER_VERSION=${CONNECTOR_TX_SENDER_VERSION:-"v0.11.0-1"}

# Coprocessor services.
export COPROCESSOR_DB_MIGRATION_VERSION=${COPROCESSOR_DB_MIGRATION_VERSION:-"v0.11.0-1"}
export COPROCESSOR_GW_LISTENER_VERSION=${COPROCESSOR_GW_LISTENER_VERSION:-"v0.11.0-1"}
export COPROCESSOR_HOST_LISTENER_VERSION=${COPROCESSOR_HOST_LISTENER_VERSION:-"v0.11.0-1"}
export COPROCESSOR_TX_SENDER_VERSION=${COPROCESSOR_TX_SENDER_VERSION:-"v0.11.0-1"}
export COPROCESSOR_TFHE_WORKER_VERSION=${COPROCESSOR_TFHE_WORKER_VERSION:-"v0.11.0-1"}
export COPROCESSOR_SNS_WORKER_VERSION=${COPROCESSOR_SNS_WORKER_VERSION:-"v0.11.0-1"}
export COPROCESSOR_ZKPROOF_WORKER_VERSION=${COPROCESSOR_ZKPROOF_WORKER_VERSION:-"v0.11.0-1"}

# Gateway and Host contracts.
export GATEWAY_VERSION=${GATEWAY_VERSION:-"v0.11.0-1"}
export HOST_VERSION=${HOST_VERSION:-"v0.11.0-1"}

# Other services.
export CORE_VERSION=${CORE_VERSION:-"v0.13.0-rc.2"}
export RELAYER_VERSION=${RELAYER_VERSION:-"v0.9.0-rc.1"}
export RELAYER_MIGRATE_VERSION=${RELAYER_MIGRATE_VERSION:-"v0.9.0-rc.1"}
export TEST_SUITE_VERSION=${TEST_SUITE_VERSION:-"v0.11.0-1"}


function print_logo() {
  echo -e "${LIGHT_BLUE}"
  echo "  ______   _    _   ______  __      __  __  __"
  echo " |  ____| | |  | | |  ____| \ \    / / |  \/  |"
  echo " | |__    | |__| | | |__     \ \  / /  | \  / |"
  echo " |  __|   |  __  | |  __|     \ \/ /   | |\/| |"
  echo " | |      | |  | | | |____     \  /    | |  | |"
  echo " |_|      |_|  |_| |______|     \/     |_|  |_|"
  echo -e "${RESET}"
}

function usage {
  print_logo
  echo -e "${BOLD}Usage:${RESET} ${YELLOW}fhevm-cli${RESET} ${CYAN}COMMAND [OPTIONS]${RESET}"
  echo
  echo -e "${BOLD}${LIGHT_BLUE}Commands:${RESET}"
  echo -e "  ${YELLOW}deploy${RESET} ${CYAN}[--build] [--local] [--coprocessors N] [--coprocessor-threshold T]${RESET}    Deploy fhevm stack"
  echo -e "  ${YELLOW}pause${RESET} ${CYAN}[CONTRACTS]${RESET}     Pause specific contracts (host|gateway)"
  echo -e "  ${YELLOW}unpause${RESET} ${CYAN}[CONTRACTS]${RESET}     Unpause specific contracts (host|gateway)"
  echo -e "  ${YELLOW}test${RESET} ${CYAN}[TYPE]${RESET}         Run tests (input-proof|multicoproc-input-proof|user-decryption|public-decryption|delegated-user-decryption|random|random-subset|operators|erc20|debug)"
  echo -e "  ${YELLOW}smoke${RESET} ${CYAN}[PROFILE]${RESET}      Run multicoproc smoke profile (multi-2-2|multi-3-5)"
  echo -e "  ${YELLOW}upgrade${RESET} ${CYAN}[SERVICE]${RESET}   Upgrade specific service (host|gateway|connector|coprocessor|relayer|test-suite)"
  echo -e "  ${YELLOW}clean${RESET}               Remove all containers and volumes"
  echo -e "  ${YELLOW}logs${RESET} ${CYAN}[SERVICE]${RESET}      View logs for a specific service"
  echo -e "  ${YELLOW}help${RESET}                Display this help message"
  echo
  echo -e "${BOLD}${LIGHT_BLUE}Test Options:${RESET}"
  echo -e "  ${CYAN}-v, --verbose${RESET}       Enable verbose output"
  echo -e "  ${CYAN}-n, --network NAME${RESET}  Specify network (default: ${GREEN}staging${RESET})"
  echo -e "  ${CYAN}-g, --grep PATTERN${RESET}  Override default test pattern"
  echo -e "  ${CYAN}-r, --no-relayer${RESET}    Disable Rust relayer"
  echo -e "  ${CYAN}--no-hardhat-compile${RESET}        Skip Hardhat compilation step"
  echo
  echo -e "${BOLD}${LIGHT_BLUE}Examples:${RESET}"
  echo -e "  ${PURPLE}./fhevm-cli deploy${RESET}"
  echo -e "  ${PURPLE}./fhevm-cli deploy --build${RESET}"
  echo -e "  ${PURPLE}./fhevm-cli deploy --local${RESET}"
  echo -e "  ${PURPLE}./fhevm-cli deploy --coprocessors 2 --coprocessor-threshold 2${RESET}"
  echo -e "  ${PURPLE}./fhevm-cli smoke multi-2-2${RESET}"
  echo -e "  ${PURPLE}./fhevm-cli smoke multi-3-5${RESET}"
  echo -e "  ${PURPLE}./fhevm-cli test input-proof${RESET}"
  echo -e "  ${PURPLE}./fhevm-cli test multicoproc-input-proof${RESET}"
  echo -e "  ${PURPLE}./fhevm-cli test input-proof --no-hardhat-compile${RESET}"
  echo -e "  ${PURPLE}./fhevm-cli test user-decryption ${RESET}"
  echo -e "  ${PURPLE}./fhevm-cli test public-decrypt-http-ebool ${RESET}"
  echo -e "  ${PURPLE}./fhevm-cli test public-decrypt-http-mixed -n staging${RESET}"
  echo -e "  ${PURPLE}./fhevm-cli test erc20${RESET}"
  echo -e "  ${PURPLE}./fhevm-cli upgrade coprocessor${RESET}"
  echo -e "${BLUE}============================================================${RESET}"
}

function collect_coprocessor_topology_logs() {
  echo -e "${LIGHT_BLUE}${BOLD}[LOGS] Collecting coprocessor topology logs (last 10m)...${RESET}"
  local containers
  containers=$(docker ps --format '{{.Names}}' | rg '^coprocessor[0-9-]*-(host-listener|gw-listener|tfhe-worker|sns-worker|transaction-sender)$' || true)
  if [ -z "$containers" ]; then
    echo -e "${YELLOW}[WARN]${RESET} No coprocessor containers found"
    return
  fi

  while IFS= read -r container; do
    [ -z "$container" ] && continue
    echo -e "\n${CYAN}===== ${container} =====${RESET}"
    docker logs --since=10m "$container" | tail -n 160 || true
  done <<< "$containers"
}

function wait_for_coprocessor_key_bootstrap() {
  local timeout_seconds=300
  local poll_interval=5
  local elapsed=0
  echo -e "${LIGHT_BLUE}${BOLD}[WAIT] Waiting for coprocessor key bootstrap...${RESET}"
  while [ "$elapsed" -lt "$timeout_seconds" ]; do
    local ready_count=0
    local total_count=0
    local pending=""
    local containers
    containers=$(docker ps --format '{{.Names}}' | rg '^coprocessor([0-9]+)?-sns-worker$' || true)
    if [ -z "$containers" ]; then
      echo -e "${YELLOW}[WARN]${RESET} No sns-worker containers found yet"
      sleep "$poll_interval"
      elapsed=$((elapsed + poll_interval))
      continue
    fi

    while IFS= read -r container; do
      [ -z "$container" ] && continue
      total_count=$((total_count + 1))
      if docker logs --since=20m "$container" 2>&1 | rg -q "Fetched keyset"; then
        ready_count=$((ready_count + 1))
      else
        pending="${pending} ${container}"
      fi
    done <<< "$containers"

    local configured_threshold=""
    if [ -f "test-suite/fhevm/env/staging/.env.host-sc.local" ]; then
      configured_threshold=$(rg '^COPROCESSOR_THRESHOLD=' test-suite/fhevm/env/staging/.env.host-sc.local -N | tail -n1 | cut -d'=' -f2 || true)
    fi
    if ! [[ "$configured_threshold" =~ ^[0-9]+$ ]] || [ "$configured_threshold" -lt 1 ]; then
      configured_threshold="$total_count"
    fi

    if [ "$configured_threshold" -gt "$total_count" ]; then
      configured_threshold="$total_count"
    fi

    if [ "$ready_count" -ge "$configured_threshold" ]; then
      echo -e "${GREEN}[READY]${RESET} Key bootstrap confirmed for ${ready_count}/${total_count} sns-worker containers (threshold=${configured_threshold})"
      return 0
    fi

    echo -e "${YELLOW}[WAIT]${RESET} Key bootstrap ready=${ready_count}/${total_count} threshold=${configured_threshold} pending:${pending}"
    sleep "$poll_interval"
    elapsed=$((elapsed + poll_interval))
  done

  echo -e "${RED}[ERROR]${RESET} Key bootstrap did not reach threshold within ${timeout_seconds}s"
  return 1
}

COMMAND=$1
shift

# Show help if no command is provided
if [ -z "$COMMAND" ]; then
  usage
  exit 0
fi

case $COMMAND in
  deploy)
    print_logo
    echo -e "${LIGHT_BLUE}${BOLD}[DEPLOY] Deploying fhevm stack...${RESET}"
    DEPLOY_ARGS=()
    while (( "$#" )); do
      case "$1" in
        --build)
          DEPLOY_ARGS+=("--build")
          shift
          ;;
        --local|--dev)
          DEPLOY_ARGS+=("--local")
          shift
          ;;
        --coprocessors)
          if [ -n "$2" ] && [ "${2:0:1}" != "-" ]; then
            DEPLOY_ARGS+=("--coprocessors" "$2")
            shift 2
          else
            echo -e "${RED}[ERROR]${RESET} ${BOLD}Coprocessor count argument missing${RESET}"
            usage
            exit 1
          fi
          ;;
        --coprocessor-threshold)
          if [ -n "$2" ] && [ "${2:0:1}" != "-" ]; then
            DEPLOY_ARGS+=("--coprocessor-threshold" "$2")
            shift 2
          else
            echo -e "${RED}[ERROR]${RESET} ${BOLD}Coprocessor threshold argument missing${RESET}"
            usage
            exit 1
          fi
          ;;
        *)
          echo -e "${RED}[ERROR]${RESET} ${BOLD}Unknown argument for deploy: $1${RESET}"
          usage
          exit 1
          ;;
      esac
    done
    "${SCRIPT_DIR}/scripts/deploy-fhevm-stack.sh" "${DEPLOY_ARGS[@]}"
    echo -e "${GREEN}${BOLD} [SUCCESS] fhevm stack deployment complete!${RESET}"
    ;;

  pause)
    print_logo
    CONTRACTS=$1
    if [[ ! $CONTRACTS =~ ^(gateway|host)$ ]]; then
      echo -e "${RED}[ERROR]${RESET} ${BOLD}Unknown service: $CONTRACTS${RESET}"
      usage
      exit 1
    fi

    echo -e "${LIGHT_BLUE}[PAUSE]${RESET} ${BOLD}Pausing $CONTRACTS...${RESET}"
    docker compose -p "${PROJECT}" -f "${SCRIPT_DIR}/docker-compose/${CONTRACTS}-pause-docker-compose.yml" up -d
    # Wait for the pause service to complete
    echo -e "${YELLOW}[WAIT]${RESET} ${BOLD}Waiting for pause operation to complete...${RESET}"
    docker compose -p "${PROJECT}" -f "${SCRIPT_DIR}/docker-compose/${CONTRACTS}-pause-docker-compose.yml" wait ${CONTRACTS}-sc-pause
    echo -e "${GREEN}[SUCCESS]${RESET} ${BOLD}$CONTRACTS paused successfully${RESET}"
    ;;

  unpause)
    print_logo
    CONTRACTS=$1
    if [[ ! $CONTRACTS =~ ^(gateway|host)$ ]]; then
      echo -e "${RED}[ERROR]${RESET} ${BOLD}Unknown service: $CONTRACTS${RESET}"
      usage
      exit 1
    fi

    echo -e "${LIGHT_BLUE}[UNPAUSE]${RESET} ${BOLD}Unpausing $CONTRACTS...${RESET}"
    docker compose -p "${PROJECT}" -f "${SCRIPT_DIR}/docker-compose/${CONTRACTS}-unpause-docker-compose.yml" up -d
    # Wait for the unpause service to complete
    echo -e "${YELLOW}[WAIT]${RESET} ${BOLD}Waiting for unpause operation to complete...${RESET}"
    docker compose -p "${PROJECT}" -f "${SCRIPT_DIR}/docker-compose/${CONTRACTS}-unpause-docker-compose.yml" wait ${CONTRACTS}-sc-unpause
    echo -e "${GREEN}[SUCCESS]${RESET} ${BOLD}$CONTRACTS unpaused successfully${RESET}"
    ;;

  test)
    print_logo
    TEST_TYPE=$1
    shift

    VERBOSE=""
    NETWORK="staging"
    GREP=""
    NO_RELAYER=""
    NO_COMPILE=""
    WAIT_FOR_KEY_BOOTSTRAP=""

    while (( "$#" )); do
      case "$1" in
        -v|--verbose)
          VERBOSE="-v"
          shift
          ;;
        -n|--network)
          if [ -n "$2" ] && [ "${2:0:1}" != "-" ]; then
            NETWORK="$2"
            shift 2
          else
            echo -e "${RED}[ERROR]${RESET} ${BOLD}Network argument missing${RESET}"
            usage
            exit 1
          fi
          ;;
        -g|--grep)
          if [ -n "$2" ] && [ "${2:0:1}" != "-" ]; then
            GREP="$2"
            shift 2
          else
            echo -e "${RED}[ERROR]${RESET} ${BOLD}Grep pattern missing${RESET}"
            usage
            exit 1
          fi
          ;;
        -r|--no-relayer)
          NO_RELAYER="-r"
          shift
          ;;
        --no-hardhat-compile)
          NO_COMPILE="--no-hardhat-compile"
          shift
          ;;
        *)
          echo -e "${RED}[ERROR]${RESET} ${BOLD}Unknown option: $1${RESET}"
          usage
          exit 1
          ;;
      esac
    done

    docker_args=("./run-tests.sh")
    if [ -n "$VERBOSE" ]; then
      docker_args+=("-v")
    fi
    docker_args+=("-n" "$NETWORK")
    if [ -n "$NO_RELAYER" ]; then
      docker_args+=("-r")
    fi
    if [ -n "$NO_COMPILE" ]; then
      docker_args+=("--no-hardhat-compile")
    fi

    if [ -n "$GREP" ]; then
      docker_args+=("-g" "$GREP")
    else
      case $TEST_TYPE in
        input-proof|multicoproc-input-proof)
          log_message="${LIGHT_BLUE}${BOLD}[TEST] INPUT PROOF (uint64)${RESET}"
          docker_args+=("-g" "test user input uint64")
          WAIT_FOR_KEY_BOOTSTRAP="1"
          ;;
        input-proof-compute-decrypt)
          log_message="${LIGHT_BLUE}${BOLD}[TEST] INPUT PROOF (uint64)${RESET}"
          docker_args+=("-g" "test add 42 to uint64 input and decrypt")
          ;;
        user-decryption)
          log_message="${LIGHT_BLUE}${BOLD}[TEST] USER DECRYPTION${RESET}"
          docker_args+=("-g" "test user decrypt")
          ;;
        delegated-user-decryption)
          log_message="${LIGHT_BLUE}${BOLD}[TEST] DELEGATED USER DECRYPTION${RESET}"
          docker_args+=("-g" "test delegated user decrypt")
          ;;
        public-decryption)
          log_message="${LIGHT_BLUE}${BOLD}[TEST] PUBLIC DECRYPTION${RESET}"
          docker_args+=("-g" "test async decrypt (uint.*|ebytes.* trivial|ebytes64 non-trivial|ebytes256 non-trivial with snapshot|addresses|several addresses)")
          ;;
        erc20)
          log_message="${LIGHT_BLUE}${BOLD}[TEST] ERC20${RESET}"
          docker_args+=("-g" "should transfer tokens between two users.")
          ;;
        public-decrypt-http-ebool)
          log_message="${LIGHT_BLUE}${BOLD}[TEST] PUBLIC DECRYPTION OVER HTTP FOR EBOOL${RESET}"
          docker_args+=("-g" "test HTTPPublicDecrypt ebool")
          ;;
        public-decrypt-http-mixed)
          log_message="${LIGHT_BLUE}${BOLD}[TEST] PUBLIC DECRYPTION OVER HTTP FOR MIXED${RESET}"
          docker_args+=("-g" "test HTTPPublicDecrypt mixed")
          ;;
        operators)
          log_message="${LIGHT_BLUE}${BOLD}[TEST] OPERATORS${RESET}"
          docker_args+=("--parallel" "-g" "test operator|FHEVM manual operations")
          ;;
        random)
          log_message="${LIGHT_BLUE}${BOLD}[TEST] RANDOM OPERATORS${RESET}"
          docker_args+=("-g" "generate and decrypt|generating rand in reverting sub-call|upper bound and decrypt")
          ;;
        random-subset)
          log_message="${LIGHT_BLUE}${BOLD}[TEST] RANDOM OPERATORS (SUBSET)${RESET}"
          docker_args+=("-g" "64 bits generate and decrypt|generating rand in reverting sub-call|64 bits generate with upper bound and decrypt")
          ;;
        paused-host-contracts)
          log_message="${LIGHT_BLUE}${BOLD}[TEST] PAUSED HOST CONTRACTS${RESET}"
          docker_args+=("-g" "test paused host.*")
          ;;
        paused-gateway-contracts)
          log_message="${LIGHT_BLUE}${BOLD}[TEST] PAUSED GATEWAY CONTRACTS${RESET}"
          docker_args+=("-g" "test paused gateway.*")
          ;;
        debug)
          echo -e "${LIGHT_BLUE}${BOLD}[DEBUG] Starting debug session...${RESET}"
          docker exec -it fhevm-test-suite-e2e-debug bash
          ;;
        *)
          echo -e "${RED}[ERROR]${RESET} ${BOLD}Unknown test type: $TEST_TYPE${RESET}"
          usage
          exit 1
          ;;
      esac
    fi
    if [ "$TEST_TYPE" != "debug" ]; then
      echo -e "${log_message}"
      if [ -n "$WAIT_FOR_KEY_BOOTSTRAP" ]; then
        wait_for_coprocessor_key_bootstrap
      fi
      test_status=0
      if docker exec fhevm-test-suite-e2e-debug "${docker_args[@]}"; then
        test_status=0
      else
        test_status=$?
      fi
      if [ -n "$WAIT_FOR_KEY_BOOTSTRAP" ]; then
        collect_coprocessor_topology_logs
      fi
      if [ "$test_status" -ne 0 ]; then
        exit "$test_status"
      fi
    fi
    ;;

  smoke)
    print_logo
    PROFILE=$1
    if [[ ! $PROFILE =~ ^(multi-2-2|multi-3-5)$ ]]; then
      echo -e "${RED}[ERROR]${RESET} ${BOLD}Unknown smoke profile: ${PROFILE}${RESET}"
      usage
      exit 1
    fi

    coprocessors=""
    threshold=""
    case "$PROFILE" in
      multi-2-2)
        coprocessors=2
        threshold=2
        ;;
      multi-3-5)
        coprocessors=5
        threshold=3
        ;;
    esac

    echo -e "${LIGHT_BLUE}${BOLD}[SMOKE] Running profile ${PROFILE} (n=${coprocessors}, t=${threshold})...${RESET}"
    "${SCRIPT_DIR}/fhevm-cli" deploy --local --coprocessors "${coprocessors}" --coprocessor-threshold "${threshold}"
    "${SCRIPT_DIR}/fhevm-cli" test multicoproc-input-proof
    ;;

  help|-h|--help)
    usage
    exit 0
    ;;

  upgrade)
    print_logo
    SERVICE=$1
    if [[ ! $SERVICE =~ ^(minio|core|gateway-node|gateway-sc|gateway-mocked-payment|host-node|host-sc|kms-connector|coprocessor|relayer|test-suite)$ ]]; then
      echo -e "${RED}[ERROR]${RESET} ${BOLD}Unknown service: $SERVICE${RESET}"
      usage
      exit 1
    fi

    echo -e "${LIGHT_BLUE}[UPGRADE]${RESET} ${BOLD}Upgrading $SERVICE...${RESET}"
    docker compose -p "${PROJECT}" --env-file "${SCRIPT_DIR}/env/staging/.env.${SERVICE}.local" -f "${SCRIPT_DIR}/docker-compose/${SERVICE}-docker-compose.yml" up -d
    echo -e "${GREEN}[SUCCESS]${RESET} ${BOLD}$SERVICE upgraded successfully${RESET}"
    ;;

  clean)
    echo -e "${LIGHT_BLUE}[CLEAN]${RESET} ${BOLD}Cleaning up FHEVM stack...${RESET}"
    docker compose -p "${PROJECT}" down -v --remove-orphans
    echo -e "${GREEN}[SUCCESS]${RESET} ${BOLD}FHEVM stack cleaned successfully${RESET}"
    ;;

  logs)
    SERVICE=$1
    if [ -z "${SERVICE}" ]; then
      echo -e "${RED}[ERROR]${RESET} ${BOLD}Service name is required${RESET}"
      usage
      exit 1
    fi

    echo -e "${LIGHT_BLUE}[LOGS]${RESET} ${BOLD}Showing logs for $SERVICE...${RESET}"
    docker logs "${SERVICE}"
    ;;

  *)
    echo -e "${RED}[ERROR]${RESET} ${BOLD}Unknown command: ${COMMAND}${RESET}"
    usage
    exit 1
    ;;
esac
