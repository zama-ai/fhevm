import { describe, expect, test } from "bun:test";

import type { DotFhevmPaths } from "../config/dotfhevm";
import type { VersionGroup } from "../config/versions";
import { ExitCode, FhevmCliError } from "../errors";

import { runPauseCommand, toPauseError } from "./pause";

const PATHS: DotFhevmPaths = {
  root: "/tmp/.fhevm",
  env: "/tmp/.fhevm/env",
  compose: "/tmp/.fhevm/compose",
  keys: "/tmp/.fhevm/keys",
  keysMinioSnapshot: "/tmp/.fhevm/keys/minio-snapshot",
  keysVolumeSnapshot: "/tmp/.fhevm/keys/volume-snapshot",
  logs: "/tmp/.fhevm/logs",
  stateFile: "/tmp/.fhevm/state.json",
  versionCache: "/tmp/.fhevm/version-cache.json",
};

const VERSIONS: Record<VersionGroup, string> = {
  coprocessor: "v1.0.0",
  "kms-connector": "v1.0.0",
  contracts: "v1.0.0",
  core: "v1.0.0",
  relayer: "v1.0.0",
  "test-suite": "v1.0.0",
};

describe("pause command", () => {
  test("validates target values", async () => {
    await expect(
      runPauseCommand("bad-target", PATHS, {
        findExistingEnvFiles: () => new Map(),
        resolveAllVersions: async () => VERSIONS,
        buildVersionEnvVars: () => ({}),
        startAndWaitForServices: async () => [],
      }),
    ).rejects.toMatchObject({
      exitCode: ExitCode.CONFIG,
      message: expect.stringContaining("invalid target"),
    });
  });

  test("requires env file generated by up", async () => {
    await expect(
      runPauseCommand("gateway", PATHS, {
        findExistingEnvFiles: () => new Map(),
        resolveAllVersions: async () => VERSIONS,
        buildVersionEnvVars: () => ({}),
        startAndWaitForServices: async () => [],
      }),
    ).rejects.toMatchObject({
      exitCode: ExitCode.CONFIG,
      message: expect.stringContaining("run 'fhevm-cli up' first"),
    });
  });

  test("runs one-shot pause service when env files exist", async () => {
    const started: string[][] = [];

    await runPauseCommand("gateway", PATHS, {
      findExistingEnvFiles: () => new Map([["gateway-sc", "/tmp/.fhevm/env/gateway-sc.env"]]),
      resolveAllVersions: async () => VERSIONS,
      buildVersionEnvVars: () => ({ GATEWAY_VERSION: "v1.0.0" }),
      startAndWaitForServices: async (services) => {
        started.push(services.map((service) => service.name));
        return [];
      },
    });

    expect(started).toEqual([["gateway-sc-pause"]]);
  });

  test("passes through typed CLI errors", () => {
    const error = new FhevmCliError({
      exitCode: ExitCode.CONFIG,
      step: "pause",
      message: "bad target",
    });

    expect(toPauseError(error)).toBe(error);
  });

  test("maps unknown errors to docker failures", () => {
    const error = toPauseError(new Error("boom"));
    expect(error.exitCode).toBe(ExitCode.DOCKER);
    expect(error.step).toBe("pause");
    expect(error.message).toBe("boom");
  });
});
