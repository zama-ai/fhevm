# Main workflow for KMS Core that handles testing and build
# Triggers:
# 1. Scheduled: Every weekday at 00:00 UTC (01:00 CET) for nightly tests and build
# 2. Pull requests: For validation before merging
# 3. Pushes: On main and release/* branches for building images
# IMPORTANT NOTES: The tests are only executed for components that have been changed
name: "[Global Common Workflow] Pipeline Run"

on:
  schedule:
    - cron: '0 0 * * 1-5' # Runs at midnight UTC (1 AM CET) Monday-Friday
  pull_request:
  push:
    branches: ['main', 'release/*']

# Controls concurrent workflow runs:
# - Groups runs by git ref
# - Cancels in-progress runs for non-main/release branches
concurrency:
  group: global-common-workflow-${{ github.ref }}
  cancel-in-progress: ${{ !contains(fromJSON('["release/", "main"]'),github.ref) }}

# Required permissions for workflow execution
permissions:
  actions: 'write'
  contents: 'write'
  id-token: 'write'
  pull-requests: 'write'
  pages: 'write'
  packages: 'write'


jobs:
  # Initial job that determines which components have changed
  # Used by subsequent jobs to decide whether they need to run
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      # Each output indicates if files in a specific component were modified
      changes-backup: ${{ steps.filter.outputs.backup }}
      changes-ci: ${{ steps.filter.outputs.ci }}
      changes-connector: ${{ steps.filter.outputs.connector }}
      changes-core-client: ${{ steps.filter.outputs.core-client }}
      changes-core-grpc: ${{ steps.filter.outputs.core-grpc }}
      changes-core-service: ${{ steps.filter.outputs.core-service }}
      changes-core-threshold: ${{ steps.filter.outputs.core-threshold }}
      changes-docs: ${{ steps.filter.outputs.docs }}
      changes-helm-chart: ${{ steps.filter.outputs.helm-chart }}
    steps:
    - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
    - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36  # v3.0.2
      id: filter
      with:
        # Define paths that trigger specific component workflows
        # Changes to conf-trace affect multiple components
        filters: |
          ci:
            - '.github/workflows/global-common-workflow.yml'
          connector:
            - './**'
          docs:
            - 'docs/**'
          helm-chart:
            - 'charts/**'
            - '.github/workflows/helm-test.yml'
            - '.github/workflows/helm-lint.yml'

  ############################################################################
  # Helm chart pipeline
  # Triggered by:
  # - Changes to charts/**'
  ############################################################################
  test-helm-chart:
    needs: check-changes
    if: needs.check-changes.outputs.changes-helm-chart == 'true'
    uses: ./.github/workflows/helm-test.yml

  lint-helm-chart:
    needs: check-changes
    if: needs.check-changes.outputs.changes-helm-chart == 'true'
    uses: ./.github/workflows/helm-lint.yml

  release-helm-chart:
    needs: check-changes
    if: github.ref == 'refs/heads/main' && needs.check-changes.outputs.changes-helm-chart == 'true'
    uses: ./.github/workflows/helm-release.yml

  ############################################################################
  # KMS Local Docs Link Check
  # Triggered by:
  # - Changes to docs/**
  # - Changes to workflow file itself
  ############################################################################
  check-docs:
    needs: check-changes
    if: needs.check-changes.outputs.changes-docs == 'true'
    runs-on: ubuntu-latest
    container:
      image: python:3.10
    steps:
    - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
    - run: python3 -m pip install linkcheckmd
    - name: Check dead-link
      run: python3 ci/script/local_docs_link_check.py


  ############################################################################
  # KMS Connector Pipeline
  # Testing triggered by:
  # - Changes to kms-connector/**
  # - Changes to conf-trace/**
  # - Changes to core/grpc/**
  # - Changes to workflow file
  ############################################################################
  test-connector:
    needs: check-changes
    if: needs.check-changes.outputs.changes-connector == 'true' || needs.check-changes.outputs.changes-ci == 'true'
    uses: ./.github/workflows/common-testing-big-instance.yml
    with:
      working-directory: './'
      package-name: 'kms-connector'
      app-cache-dir: 'kms-connector'
    secrets:
      BLOCKCHAIN_ACTIONS_TOKEN: ${{ secrets.BLOCKCHAIN_ACTIONS_TOKEN }}
      SLAB_ACTION_TOKEN: ${{ secrets.SLAB_ACTION_TOKEN }}
      SLAB_BASE_URL: ${{ secrets.SLAB_BASE_URL }}
      JOB_SECRET: ${{ secrets.JOB_SECRET }}
      AWS_ACCESS_KEY_S3_USER: ${{ secrets.AWS_ACCESS_KEY_S3_USER }}
      AWS_SECRET_KEY_S3_USER: ${{ secrets.AWS_SECRET_KEY_S3_USER }}

  # Builds Docker image for connector
  # Only runs on main/release branches after successful tests
  # Also runs on pull requests targeting main/release branches with the docker label
  docker-connector:
    needs:
      - test-connector
    if: >-
      (startsWith(github.ref, 'refs/heads/release/') || github.ref == 'refs/heads/main') ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'docker'))
    uses: ./.github/workflows/common-docker-big-instance.yml
    with:
      working-directory: "./kms-connector"
      push_image: true
      image-name: 'kms-connector'
      app-cache-dir: 'kms-connector'
    secrets:
      BLOCKCHAIN_ACTIONS_TOKEN: ${{ secrets.BLOCKCHAIN_ACTIONS_TOKEN }}
      SLAB_ACTION_TOKEN: ${{ secrets.SLAB_ACTION_TOKEN }}
      SLAB_BASE_URL: ${{ secrets.SLAB_BASE_URL }}
      JOB_SECRET: ${{ secrets.JOB_SECRET }}
      AWS_ACCESS_KEY_S3_USER: ${{ secrets.AWS_ACCESS_KEY_S3_USER }}
      AWS_SECRET_KEY_S3_USER: ${{ secrets.AWS_SECRET_KEY_S3_USER }}
