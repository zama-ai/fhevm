# =============================================================================
# FHEVM Smart Contracts Configuration
# =============================================================================
# This chart handles the deployment and management of FHEVM smart contracts
# for both Gateway and Host chains, including:
# - Contract deployment
# - Contract upgrades
# - Configuration management
# - Debugging utilities
# =============================================================================

# NOTE: These values are for reference only
# The chart is shared between gateway and host deployments

# -----------------------------------------------------------------------------
# Smart Contract Deployment
# -----------------------------------------------------------------------------
# Handles initial deployment of all required smart contracts
scDeploy:
  enabled: true
  
  # Prevent redeployment if already done for current version
  # preventRedeployment: false
  
  nameOverride:
  
  image:
    name: ghcr.io/zama-ai/fhevm/host-contracts
    tag: v0.7.0
  
  # ConfigMap to store deployed contract addresses
  configmap:
    name: "sc-addresses"
    annotations:
  
  # Environment variables for contract deployment
  env:
    # =========================================================================
    # ==========================  GATEWAY =====================================
    # =========================================================================

    # =========================================================================
    # NEW ENVIRONMENT VARIABLES
    # =========================================================================
    
    # KMS generation threshold (for 13 nodes, threshold is 7)
    - name: KMS_GENERATION_THRESHOLD
      value: 7
    
    # S3 URL for KMS core storage
    - name: KMS_NODE_STORAGE_URL_x
      value: ""
    
    # Number of pausers: 13 KMS cores + 1 Coprocessor = 14 total
    - name: NUM_PAUSERS
      value: 14
    
    # Pauser addresses (replace x with sequential numbers)
    - name: PAUSER_ADDRESS_x
      value: ""
    
    # =========================================================================
    # ==========================  HOST    =====================================
    # =========================================================================

    # =========================================================================
    # NEW ENVIRONMENT VARIABLES
    # =========================================================================
    
    # Number of pausers: 13 KMS cores + 1 Coprocessor = 14 total
    - name: NUM_PAUSERS
      value: 14
    
    # Pauser addresses (replace x with sequential numbers)
    - name: PAUSER_ADDRESS_x
      value: ""
    
    # =========================================================================
    # DEPRECATED ENVIRONMENT VARIABLES
    # =========================================================================
    # The following environment variables are no longer used:
    # - PAUSER_ADDRESS
    # - FHE_PARAMS_NAME
    # - FHE_PARAMS_DIGEST
  
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  
  # Security context for container execution
  securityContext:
    runAsNonRoot: true
    runAsUser: 10000
    fsGroup: 10001
  
  # Deployment commands executed in sequence
  deployCommands:
    # =========================================================================
    # ==========================  GATEWAY =====================================
    # =========================================================================
    # Deploy all gateway contracts
    - "npx --no-install hardhat task:deployAllGatewayContracts"
    
    # Add network configuration
    - "npx --no-install hardhat task:addHostChainsToGatewayConfig"
    
    # =========================================================================
    # NEW Commands
    # =========================================================================
    # Add Gateway pausers for emergency stops
    - npx hardhat task:addGatewayPausers
    
    # Trigger key generation for cryptographic operations
    - npx hardhat task:triggerKeygen --params-type 1
    
    # Trigger CRS (Common Reference String) generation
    - npx hardhat task:triggerCrsgen --params-type 1 --max-bit-length 2048

    # =========================================================================
    # ==========================  HOST    =====================================
    # =========================================================================
    # Deploy all host contracts
    - "npx --no-install hardhat task:deployAllHostContracts"

    # =========================================================================
    # NEW Commands
    # =========================================================================
    # Add Host pausers for emergency stops
    - npx hardhat task:addHostPausers
  
  # Contract verification on block explorers
  verifyContracts: false

# -----------------------------------------------------------------------------
# Smart Contract Upgrade
# -----------------------------------------------------------------------------
# Handles upgrades of existing smart contracts
scUpgrade:
  enabled: false
  
  # Configuration for old contracts (used during upgrade process)
  oldContracts:
    image:
      name: ghcr.io/zama-ai/fhevm/host-contracts
      tag: v0.7.0-rc2
  
  # Note: The upgrade process uses the new contracts image from scDeploy.image
  
  # Upgrade commands executed during contract upgrade
  upgradeCommands:
    # Example upgrade command (uncomment and modify as needed)
    # - npx hardhat task:upgrade

# -----------------------------------------------------------------------------
# Node Placement Configuration
# -----------------------------------------------------------------------------
# Uncomment to use specific node selector and toleration for deployment

# nodeSelector:
#   kubernetes.io/arch: amd64

# tolerations:
#   - key: "node.kubernetes.io/arch"
#     operator: "Equal"
#     value: "amd64"
#     effect: "NoSchedule"

# affinity:
#   nodeAffinity:
#     required:
#       nodeSelectorTerm:
#         matchExpressions:
#           - key: kubernetes.io/arch
#             operator: In
#             values:
#               - amd64

# -----------------------------------------------------------------------------
# Smart Contract Debugging
# -----------------------------------------------------------------------------
# Utilities for debugging smart contract deployments
scDebug:
  enabled: false
  nameOverride:

# -----------------------------------------------------------------------------
# Persistent Storage Configuration
# -----------------------------------------------------------------------------
# Configuration for persistent volumes used during deployment
persistence:
  enabled: true
  
  volumeClaim:
    name: ""
    create: true
    storageClassName: ""
    storageCapacity: 1Gi

# -----------------------------------------------------------------------------
# Global Pod Configuration
# -----------------------------------------------------------------------------
# Pod annotations for additional metadata
# See: https://kubernetes.io/docs/concepts/overview/working-with-objects/annotations/
podAnnotations: {}

# Pod labels for selection and organization
# See: https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/
podLabels: {}
