name: claude-review

# Triggered by @claude mention in PR comments.
# The prompt is extracted as the text after "@claude" in the comment body.
#
# Security model:
#   - Only write/admin users can trigger (enforced by permission check on the App token)
#   - Network sandbox: Squid proxy (L7 domain allowlist) + iptables (L3 egress block)
#   - Claude CLI pre-installed before network lockdown
#
# Secrets:
#   - CLAUDE_CODE_OAUTH_TOKEN: Anthropic API auth (from `claude setup-token`)
#   - CLAUDE_ACCESS_TOKEN: PAT with 'repo' scope for cloning private repos (zama-marketplace, tech-spec)

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions: {}

jobs:
  claude-review:
    name: claude-review
    if: |
      contains(github.event.comment.body, '@claude') &&
      (github.event.issue.pull_request || github.event_name == 'pull_request_review_comment')
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read        # Checkout repository code and read files
      pull-requests: write  # Post review comments and update PR status
      issues: write         # Respond to @claude mentions in issue comments
      id-token: write       # OIDC token for GitHub App token exchange
    steps:

      # ── Phase 1: Setup (full network) ──────────────────────────────────

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Install uv # Required by internal skill scripts
        uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b

      - name: Clone private repositories
        run: |
          gh repo clone zama-ai/zama-marketplace /tmp/zama-marketplace
          gh repo clone zama-ai/tech-spec /tmp/tech-spec
        env:
          GH_TOKEN: ${{ secrets.CLAUDE_ACCESS_TOKEN }}

      - name: Fetch PR/issue metadata
        run: |
          if [[ -n "$ISSUE_PR_URL" ]]; then
            PR_NUMBER="$ISSUE_NUMBER_INPUT"
            PR_DATA=$(gh pr view "$PR_NUMBER" --json title,author,headRefName,baseRefName,state,additions,deletions,commits,files)

            {
              echo "FORMATTED_CONTEXT<<EOF"
              echo "PR Title: $(echo "$PR_DATA" | jq -r '.title')"
              echo "PR Author: $(echo "$PR_DATA" | jq -r '.author.login')"
              echo "PR Number: ${PR_NUMBER}"
              echo "PR Branch: $(echo "$PR_DATA" | jq -r '.headRefName') -> $(echo "$PR_DATA" | jq -r '.baseRefName')"
              echo "PR State: $(echo "$PR_DATA" | jq -r '.state | ascii_upcase')"
              echo "PR Additions: $(echo "$PR_DATA" | jq -r '.additions')"
              echo "PR Deletions: $(echo "$PR_DATA" | jq -r '.deletions')"
              echo "Total Commits: $(echo "$PR_DATA" | jq -r '.commits | length')"
              echo "Changed Files: $(echo "$PR_DATA" | jq '.files | length') files"
              echo "EOF"
            } >> "$GITHUB_ENV"
          else
            {
              echo "FORMATTED_CONTEXT<<EOF"
              echo "Issue Title: ${ISSUE_TITLE_INPUT}"
              echo "Issue Author: ${ISSUE_AUTHOR_INPUT}"
              echo "Issue State: ${ISSUE_STATE_INPUT^^}"
              echo "EOF"
            } >> "$GITHUB_ENV"
          fi
        env:
          GH_TOKEN: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
          ISSUE_PR_URL: ${{ github.event.issue.pull_request.url || '' }}
          ISSUE_NUMBER_INPUT: ${{ github.event.issue.number }}
          ISSUE_TITLE_INPUT: ${{ github.event.issue.title }}
          ISSUE_AUTHOR_INPUT: ${{ github.event.issue.user.login }}
          ISSUE_STATE_INPUT: ${{ github.event.issue.state }}

      - name: Build custom system prompt
        run: |
          SYSTEM_PROMPT="You are Claude, an AI assistant running in a non-interactive CI environment. You MUST act autonomously: never ask for confirmation, never ask follow-up questions, never wait for user input. Execute the requested task completely and stop.

          <formatted_context>
          ${FORMATTED_CONTEXT}
          </formatted_context>"

          {
            echo "CUSTOM_SYSTEM_PROMPT<<EOF"
            echo "$SYSTEM_PROMPT"
            echo "EOF"
          } >> "$GITHUB_ENV"

      # ── Phase 2: Authenticate & install CLI (before lockdown) ──────────

      - name: Exchange OIDC for GitHub App token
        id: oidc-exchange
        run: |
          OIDC_TOKEN=$(curl -sf \
            -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=claude-code-github-action" | jq -r '.value')
          if [ -z "$OIDC_TOKEN" ] || [ "$OIDC_TOKEN" = "null" ]; then
            echo "::error::OIDC token request failed"; exit 1
          fi

          APP_TOKEN=$(curl -sf -X POST \
            -H "Authorization: Bearer $OIDC_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"permissions":{"contents":"write","pull_requests":"write","issues":"write"}}' \
            "https://api.anthropic.com/api/github/github-app-token-exchange" | jq -r '.token')
          if [ -z "$APP_TOKEN" ] || [ "$APP_TOKEN" = "null" ]; then
            echo "::error::Token exchange failed"; exit 1
          fi

          echo "::add-mask::$APP_TOKEN"
          echo "app_token=$APP_TOKEN" >> "$GITHUB_OUTPUT"

      - name: Post tracking comment
        id: tracking-comment
        run: |
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          ISSUE_NUMBER="${{ github.event.issue.number || github.event.pull_request.number }}"
          BODY="**Claude is working on @${ACTOR}'s request...** — [View run]($RUN_URL)"
          COMMENT_ID=$(gh api "repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/comments" \
            -X POST -f body="$BODY" --jq '.id')
          echo "comment_id=$COMMENT_ID" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ steps.oidc-exchange.outputs.app_token }}
          ACTOR: ${{ github.actor }}

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code@2.1.42

      # ── Phase 3: Network sandbox ───────────────────────────────────────

      - name: Cache Squid Docker image
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: /tmp/squid-image.tar
          key: squid-image-ubuntu-squid-latest

      - name: Load or pull Squid image
        run: |
          if [ -f /tmp/squid-image.tar ]; then
            docker load < /tmp/squid-image.tar
          else
            docker pull ubuntu/squid
            docker save ubuntu/squid > /tmp/squid-image.tar
          fi

      - name: Start Squid proxy
        run: |
          docker run -d --name sandbox-proxy -p 3128:3128 \
            -v "${{ github.workspace }}/.github/squid/sandbox-proxy-rules.conf:/etc/squid/conf.d/00-sandbox-proxy-rules.conf:ro" \
            ubuntu/squid

          # Wait for readiness (api.github.com returns 200 without auth, unlike api.anthropic.com)
          for i in $(seq 1 30); do
            curl -sf -x http://localhost:3128 -o /dev/null https://api.github.com 2>/dev/null && break
            [ "$i" -eq 30 ] && { echo "::error::Squid proxy failed to start"; docker logs sandbox-proxy; exit 1; }
            sleep 2
          done

          # Verify: allowed domain works, blocked domain is rejected
          HTTP_CODE=$(curl -s -x http://localhost:3128 -o /dev/null -w '%{http_code}' https://api.github.com)
          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 400 ]; then
            echo "::error::Allowed domain returned $HTTP_CODE"; exit 1
          fi
          if curl -sf -x http://localhost:3128 -o /dev/null https://google.com 2>/dev/null; then
            echo "::error::Blocked domain reachable!"; exit 1
          fi

      - name: Lock down iptables
        run: |
          RUNNER_UID=$(id -u)
          # Save current firewall rules so they can be restored during always-run cleanup.
          sudo iptables-save | tee /tmp/iptables-pre-claude.rules > /dev/null

          # Resolve Squid container's IP dynamically to avoid allowing the entire 172.16/12 range
          SQUID_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' sandbox-proxy)
          if [ -z "$SQUID_IP" ]; then
            echo "::error::Could not determine Squid container IP"; exit 1
          fi
          echo "Squid IP: $SQUID_IP"

          # Allow established connections and loopback (covers local DNS via 127.0.0.53)
          sudo iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
          sudo iptables -A OUTPUT -o lo -j ACCEPT

          # Allow traffic to Squid container only (single host, port 3128)
          sudo iptables -A OUTPUT -d "$SQUID_IP" -p tcp --dport 3128 -j ACCEPT

          # Block new outbound TCP from runner UID — forces proxy use
          sudo iptables -A OUTPUT -m owner --uid-owner "$RUNNER_UID" -p tcp --syn -j REJECT --reject-with tcp-reset

          # Block UDP and ICMP from runner UID — prevents DNS tunneling and ICMP exfiltration
          sudo iptables -A OUTPUT -m owner --uid-owner "$RUNNER_UID" -p udp -j DROP
          sudo iptables -A OUTPUT -m owner --uid-owner "$RUNNER_UID" -p icmp -j DROP

          # Verify: direct blocked, proxy works
          if curl -sf --max-time 5 -o /dev/null https://google.com 2>/dev/null; then
            echo "::error::Direct connection not blocked!"; exit 1
          fi
          if ! curl -sf --max-time 10 -x http://localhost:3128 -o /dev/null https://api.github.com 2>/dev/null; then
            echo "::error::Proxy broken!"; exit 1
          fi

      # ── Phase 4: Run Claude Code (sandboxed) ───────────────────────────
      #
      # Runs claude directly (no action wrapper) to avoid MCP server processes
      # that block on stdin and keep the job alive after Claude finishes.
      # See: https://github.com/anthropics/claude-code-action/issues/865

      - name: Run Claude Code
        id: run-claude
        run: |
          # Install plugins from local marketplace (no network needed)
          claude plugin marketplace add /tmp/zama-marketplace
          claude plugin install project-manager@zama-marketplace
          claude plugin install zama-developer@zama-marketplace

          # Extract prompt: everything after "@claude" in the comment
          PROMPT=${COMMENT_BODY#*@claude }

          claude -p "$PROMPT" \
            --model opus \
            --dangerously-skip-permissions \
            --verbose \
            --system-prompt "$CUSTOM_SYSTEM_PROMPT"
        env:
          GITHUB_TOKEN: ${{ steps.oidc-exchange.outputs.app_token }}
          GH_TOKEN: ${{ steps.oidc-exchange.outputs.app_token }}
          HTTP_PROXY: http://localhost:3128
          HTTPS_PROXY: http://localhost:3128
          NO_PROXY: localhost,127.0.0.1
          COMMENT_BODY: ${{ github.event.comment.body }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

      # ── Cleanup ────────────────────────────────────────────────────────

      - name: Update tracking comment
        if: always() && steps.tracking-comment.outputs.comment_id != ''
        run: |
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          if [ "$CLAUDE_OUTCOME" = "success" ]; then
            BODY="**Claude finished @${ACTOR}'s task** — [View run]($RUN_URL)"
          else
            BODY="**Run finished with status: ${CLAUDE_OUTCOME}** — [View run]($RUN_URL)"
          fi
          gh api "repos/${{ github.repository }}/issues/comments/${{ steps.tracking-comment.outputs.comment_id }}" \
            -X PATCH -f body="$BODY"
        env:
          GH_TOKEN: ${{ steps.oidc-exchange.outputs.app_token }}
          HTTPS_PROXY: http://localhost:3128
          ACTOR: ${{ github.actor }}
          CLAUDE_OUTCOME: ${{ steps.run-claude.outcome }}

      - name: Revoke GitHub App token
        if: always() && steps.oidc-exchange.outputs.app_token != ''
        run: |
          gh api "installation/token" -X DELETE || {
            echo "::warning::Token revocation failed"
          }
        env:
          GH_TOKEN: ${{ steps.oidc-exchange.outputs.app_token }}
          HTTPS_PROXY: http://localhost:3128

      - name: Restore iptables
        if: always()
        run: |
          if [ -f /tmp/iptables-pre-claude.rules ]; then
            sudo sh -c 'iptables-restore < /tmp/iptables-pre-claude.rules' || echo "::warning::Failed to restore iptables"
          else
            echo "::warning::No iptables backup found at /tmp/iptables-pre-claude.rules"
          fi

      - name: Stop Squid proxy
        if: always()
        run: docker rm -f sandbox-proxy 2>/dev/null || true
