name: claude-review

# Triggered by: @claude mention in PR comments (e.g., "@claude review this function")
#
# How prompt extraction works:
# The action's `extractUserRequest` function automatically extracts text AFTER "@claude".
# Example: "@claude review auth" → "review auth"
#
# See: https://github.com/anthropics/claude-code-action/blob/main/src/utils/extract-user-request.ts
#
# Security: Only users with write/admin permissions can trigger Claude.
# External contributors (fork PRs) are automatically blocked by the action.
# See: https://github.com/anthropics/claude-code-action/blob/main/src/github/validation/permissions.ts
#
# Secrets required:
# - CLAUDE_CODE_OAUTH_TOKEN: OAuth token from `claude setup-token`
#
# Note: Private marketplaces are cloned in a separate step using the Claude GitHub App token,
# then passed as a local path to avoid git auth issues in the action's setup.

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions: {}

jobs:
  claude-review:
    name: claude-review/respond
    if: |
      contains(github.event.comment.body, '@claude') &&
      (github.event.issue.pull_request || github.event_name == 'pull_request_review_comment')
    runs-on: ubuntu-latest
    permissions:
      contents: read # Required for checkout
      pull-requests: write # Required for PR review and comment actions
      issues: write # Required for issue comment actions
      id-token: write # Required for OIDC authentication
      actions: read # Required for reading CI results
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b

      - name: Get Claude App token
        id: claude-token
        run: |
          # Get OIDC token
          OIDC_RESPONSE=$(curl -s -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=claude-code-github-action")
          OIDC_TOKEN=$(echo "$OIDC_RESPONSE" | jq -r '.value')

          if [ -z "$OIDC_TOKEN" ] || [ "$OIDC_TOKEN" = "null" ]; then
            echo "❌ Failed to get OIDC token"
            exit 1
          fi

          # Exchange for GitHub App token
          APP_RESPONSE=$(curl -s -X POST https://api.anthropic.com/api/github/github-app-token-exchange \
            -H "Authorization: Bearer $OIDC_TOKEN")
          APP_TOKEN=$(echo "$APP_RESPONSE" | jq -r '.token // .app_token')

          if [ -z "$APP_TOKEN" ] || [ "$APP_TOKEN" = "null" ]; then
            echo "❌ Failed to exchange for App token"
            exit 1
          fi

          echo "token=$APP_TOKEN" >> "$GITHUB_OUTPUT"

      - name: Clone private marketplace
        run: |
          gh repo clone zama-ai/zama-marketplace /tmp/zama-marketplace
        env:
          GH_TOKEN: ${{ steps.claude-token.outputs.token }}

      - name: Run Claude Code
        uses: anthropics/claude-code-action@a017b830c03e23789b11fb69ed571ea61c12e45c # 2026-01-16
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          plugin_marketplaces: "/tmp/zama-marketplace"
          plugins: |
            project-manager@zama-marketplace
            zama-developer@zama-marketplace
          # Prompt: empty string for comments (action extracts text after @claude)
          prompt: ""
